const EMBED_ORIGIN="https://realtreasury.com";let treasuryTechPortal;function postHeight(){if(window.parent!==window){const e=Math.max(document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.body.scrollHeight,document.body.offsetHeight,window.innerHeight);window.parent.postMessage({type:"treasury-height",height:e+100},"*");try{window.parent.postMessage({type:"treasury-height",height:e+100},EMBED_ORIGIN)}catch(e){}}}function debounce(e,t){let s;return function(){clearTimeout(s),s=setTimeout(e,t)}}const debouncedPostHeight=debounce(postHeight,100);window.addEventListener("load",()=>{setTimeout(postHeight,100),setTimeout(postHeight,500),setTimeout(postHeight,1e3)}),window.addEventListener("resize",debouncedPostHeight),new ResizeObserver(()=>{debouncedPostHeight()}).observe(document.body),new MutationObserver(()=>{debouncedPostHeight()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),document.addEventListener("DOMContentLoaded",()=>{treasuryTechPortal=new TreasuryTechPortal("undefined"!=typeof TTP_DATA?TTP_DATA.tools:void 0),setTimeout(()=>{"function"==typeof postHeight&&postHeight()},1500),window.addEventListener("resize",()=>{window.innerWidth<=768?(treasuryTechPortal.sideMenuOpen&&treasuryTechPortal.closeSideMenu(),treasuryTechPortal.shortlistMenuOpen&&treasuryTechPortal.closeShortlistMenu()):treasuryTechPortal.renderShortlist(),setTimeout(()=>{"function"==typeof postHeight&&postHeight()},200)})});class TreasuryTechPortal{constructor(e){this.TREASURY_TOOLS=e||[],this.loadTools().then(()=>this.init()),this.CATEGORY_INFO={CASH:{name:"Cash Tools",badge:"Essential",description:"Cash Tools are the essential first step for treasury teams moving away from manual spreadsheets. These platforms provide a single, unified view of bank balances and transactions through direct bank connections (via API or files). They excel at providing clear, real-time cash visibility and basic forecasting, allowing businesses to understand their current cash position and anticipate future needs without the complexity of a full TRMS.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],videoUrl:""},LITE:{name:"TMS-Lite",badge:"Scalable",description:"TMS-Lite solutions bridge the gap between basic Cash Tools and enterprise TRMS platforms. They build upon cash visibility by adding crucial treasury functions like multi-currency cash positioning, initiating treasury payments (wires, transfers), and managing basic financial instruments like foreign exchange contracts. These systems are ideal for growing companies whose needs have outpaced simple cash tools but do not yet require the full complexity of an enterprise system.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)"],videoUrl:""},TRMS:{name:"Treasury & Risk Management Systems (TRMS)",badge:"Advanced",description:"Treasury & Risk Management Systems (TRMS) are comprehensive platforms for large, complex organizations. They offer a broad suite of tightly integrated modules far beyond cash visibility, covering debt and investment management, advanced financial risk analysis (FX, interest rates, commodities), hedge accounting, global payments, and in-house banking. These systems are designed to centralize and automate sophisticated treasury workflows.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations","AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity"],videoUrl:""}};const t=["Bank Connectivity","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],s=[...t,"Cash Positioning","Market Data","Treasury Payments"],o=[...s,"AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations"];this.CATEGORY_TAGS={CASH:t,LITE:s,TRMS:o},this.currentFilter="ALL",this.searchTerm="",this.filteredTools=[],this.allTags=[],this.advancedFilters={features:[],hasVideo:!1},this.currentSort="name",this.currentView="grid",this.groupByCategory=!0,this.sideMenuOpen=!1,this.shortlist=[],this.shortlistMenuOpen=!1,this.touchDragTool=null,this.previousFocusedElement=null,this.handleOutsideSideMenuClick=e=>{const t=document.getElementById("sideMenu"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");!t||t.contains(e.target)||s?.contains(e.target)||o?.contains(e.target)||(e.stopPropagation(),this.closeSideMenu())},this.handleOutsideShortlistMenuClick=e=>{const t=document.getElementById("shortlistMenu"),s=document.getElementById("shortlistMenuToggle"),o=document.getElementById("externalShortlistToggle");!t||t.contains(e.target)||s?.contains(e.target)||o?.contains(e.target)||this.closeShortlistMenu()}}async loadTools(){if(this.TREASURY_TOOLS.length)return;const e=localStorage.getItem("ttp_tools");if(e)try{return void(this.TREASURY_TOOLS=JSON.parse(e))}catch(e){}try{const e="undefined"!=typeof TTP_DATA&&TTP_DATA.rest_url?`${TTP_DATA.rest_url}?per_page=100&page=1`:`${EMBED_ORIGIN}/wp-json/ttp/v1/tools?per_page=100&page=1`,t=await fetch(e);t.ok&&(this.TREASURY_TOOLS=await t.json(),localStorage.setItem("ttp_tools",JSON.stringify(this.TREASURY_TOOLS)))}catch(e){console.error("Failed to load tools",e)}}isMobile(){return window.matchMedia("(max-width: 768px)").matches}handleResponsive(){const e=this.isMobile();document.querySelectorAll(".tool-card").forEach(t=>{t.draggable=!e}),e&&(this.closeSideMenu(),this.closeShortlistMenu())}init(){this.assignTags(),this.setupInteractions(),this.setupSearch(),this.setupModals(),this.setupSideMenu(),this.setupShortlistMenu(),this.setupBottomNav(),this.updateCounts(),this.populateCategoryTags(),this.filterAndDisplayTools(),this.applyViewStyles(),this.handleResponsive(),window.addEventListener("resize",()=>this.handleResponsive()),setTimeout(()=>{const e=document.getElementById("loadingScreen");e&&(e.style.display="none")},800)}assignTags(){this.TREASURY_TOOLS.forEach(e=>{const t=this.CATEGORY_TAGS[e.category]||[];e.tags=[...t].sort((e,t)=>e.localeCompare(t))})}setupInteractions(){document.querySelectorAll(".filter-tab").forEach(e=>{e.addEventListener("click",e=>{document.querySelector(".filter-tab.active")?.classList.remove("active"),e.target.classList.add("active"),this.currentFilter=e.target.dataset.category,this.filterAndDisplayTools()})}),document.querySelectorAll(".category-header").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".show-more-category-tags-btn")||t.target.closest(".show-less-category-tags-btn"))return;const s=e.dataset.category;s&&this.CATEGORY_INFO[s]&&this.showCategoryModal(this.CATEGORY_INFO[s],s)})}),document.getElementById("mainContent").addEventListener("click",e=>{if(e.target.classList.contains("show-more-tags-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const t=e.target.parentElement,o=[...s.tags].sort((e,t)=>e.localeCompare(t));t.innerHTML=o.map(e=>`<span class="tool-tag">${e}</span>`).join(""),t.innerHTML+=`<button class="show-less-tags-btn" data-tool-name="${s.name}">Show less</button>`}}else if(e.target.classList.contains("show-less-tags-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const t=e.target.parentElement,o=[...s.tags].sort((e,t)=>e.localeCompare(t)),n=o.slice(0,3),i=o.length>3;t.innerHTML=n.map(e=>`<span class="tool-tag">${e}</span>`).join(""),i&&(t.innerHTML+=`<button class="show-more-tags-btn" data-tool-name="${s.name}">... more</button>`)}}else if(e.target.classList.contains("show-more-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,s=e.target.parentElement,o=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t));s.innerHTML=o.map(e=>`<span class="category-tag">${e}</span>`).join(""),s.innerHTML+=`<button class="show-less-category-tags-btn" data-category="${t}">Show less</button>`}else if(e.target.classList.contains("show-less-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,s=e.target.parentElement,o=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t)),n=o.slice(0,3),i=o.length>3;s.innerHTML=n.map(e=>`<span class="category-tag">${e}</span>`).join(""),i&&(s.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${t}">... more</button>`)}})}setupSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchClear");e&&(e.addEventListener("input",e=>{this.searchTerm=e.target.value.toLowerCase(),t&&(t.style.display=this.searchTerm?"block":"none"),this.filterAndDisplayTools()}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.closeSideMenu())})),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),this.searchTerm="",t.style.display="none",this.filterAndDisplayTools()})}setupTagSearch(){const e=document.getElementById("tagSearchInput"),t=document.getElementById("tagSearchClear");e&&e.addEventListener("input",()=>{const s=e.value.toLowerCase();t&&(t.style.display=s?"block":"none"),this.filterTagCheckboxes(s)}),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),t.style.display="none",this.filterTagCheckboxes("")})}filterTagCheckboxes(e){const t=document.getElementById("tagFilters");if(!t)return;t.querySelectorAll(".checkbox-item").forEach(t=>{const s=t.textContent.toLowerCase();t.style.display=s.includes(e)?"flex":"none"});const s=document.getElementById("showMoreTagFilters"),o=document.getElementById("showLessTagFilters"),n=document.getElementById("extraTagFilters");s&&o&&n&&(e?(n.style.display="block",s.style.display="none",o.style.display="none"):(n.style.display="none",o.style.display="none",s.style.display="inline-block"))}setupModals(){const e=document.getElementById("toolModal"),t=document.getElementById("modalClose");t&&t.addEventListener("click",()=>this.closeModal("toolModal")),e&&e.addEventListener("click",e=>{null===e.target.closest(".modal-content")&&this.closeModal("toolModal")});const s=document.getElementById("categoryModal"),o=document.getElementById("categoryModalClose");o&&o.addEventListener("click",()=>this.closeModal("categoryModal")),s&&s.addEventListener("click",e=>{null===e.target.closest(".modal-content")&&this.closeModal("categoryModal")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.closeModal("toolModal"),this.closeModal("categoryModal"))})}openModal(e){if(e){this.previousFocusedElement=document.activeElement,e.classList.add("show"),document.body.classList.add("modal-open");const t=e.querySelector('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(t)t.focus();else{const t=e.querySelector(".modal-content");t&&t.focus()}}}showToolModal(e){const t=document.getElementById("toolModal"),s=document.getElementById("modalTitle"),o=document.getElementById("modalDescription"),n=document.getElementById("modalWebsiteLink"),i=t?.querySelector(".modal-body"),a=document.getElementById("modalToolLogo");if(!t||!i)return;s&&(s.textContent=e.name),o&&(o.textContent=e.desc),n&&(e.websiteUrl?(n.href=e.websiteUrl,n.style.display="inline-flex"):n.style.display="none"),a&&(e.logoUrl?(a.src=e.logoUrl,a.alt=`${e.name} logo`,a.style.display="block"):a.style.display="none");const l=i.querySelector(".video-demo-section");if(l&&l.remove(),e.videoUrl){const t=document.createElement("div");t.className="feature-section video-demo-section";let s=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){s=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else if(e.videoUrl.includes("youtube.com/watch")){s=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}s+=(s.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",t.innerHTML=`\n                <h4>🎥 Demo Video</h4>\n                <div class="video-container">\n                    <iframe src="${s}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>\n                </div>\n            `,i.insertBefore(t,i.firstChild)}this.openModal(t)}showCategoryModal(e,t){const s=document.getElementById("categoryModal"),o=document.getElementById("categoryModalTitle"),n=document.getElementById("categoryModalDescription"),i=document.getElementById("categoryModalFeatures"),a=s?.querySelector(".modal-body");o&&(o.textContent=e.name),n&&(n.textContent=e.description),i&&(i.innerHTML="",e.features.forEach(e=>{const t=document.createElement("li");t.textContent=e,i.appendChild(t)}));const l=a?.querySelector(".video-demo-section");if(l&&l.remove(),e.videoUrl&&a){const t=document.createElement("div");t.className="feature-section video-demo-section";let s=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){s=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else if(e.videoUrl.includes("youtube.com/watch")){s=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}s+=(s.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",t.innerHTML=`\n                <h4>🎥 Category Overview Video</h4>\n                <div class="video-container">\n                     <iframe src="${s}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>\n                </div>\n            `,a.insertBefore(t,a.firstChild)}this.openModal(s)}closeModal(e){const t=document.getElementById(e);if(t&&t.classList.contains("show")){t.classList.remove("show"),document.body.classList.remove("modal-open");const e=t.querySelector("iframe");e&&e.contentWindow&&e.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}',"https://www.youtube.com"),this.previousFocusedElement&&(this.previousFocusedElement.focus(),this.previousFocusedElement=null)}}filterAndDisplayTools(){let e;if(this.searchTerm){const t=this.searchTerm.toLowerCase();e=this.TREASURY_TOOLS.filter(e=>[e.name,e.desc,e.target,...e.tags||[],...e.features||[]].join(" ").toLowerCase().includes(t))}else e="ALL"===this.currentFilter?this.TREASURY_TOOLS:this.TREASURY_TOOLS.filter(e=>e.category===this.currentFilter);this.advancedFilters.features.length&&(e=e.filter(e=>this.advancedFilters.features.every(t=>(e.tags||[]).includes(t)))),this.advancedFilters.hasVideo&&(e=e.filter(e=>e.videoUrl)),"name"===this.currentSort?e=e.sort((e,t)=>e.name.localeCompare(t.name)):"category"===this.currentSort&&(e=e.sort((e,t)=>e.category.localeCompare(t.category))),this.filteredTools=e,this.displayFilteredTools(),this.updateVisibleCounts()}displayFilteredTools(){const e=["CASH","LITE","TRMS"],t=this.filteredTools.length>0,s=document.getElementById("noResults");s&&(s.style.display=t?"none":"block");const o=document.getElementById("listViewContainer");if(!this.groupByCategory||"list"===this.currentView||this.searchTerm||this.advancedFilters.features.length||this.advancedFilters.hasVideo)return e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`);t&&(t.style.display="none")}),void(o&&(o.innerHTML="",this.filteredTools.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const t=this.createToolCard(e,e.category);o.appendChild(t)}),o.style.display=t?"grid":"none"));o&&(o.style.display="none"),e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`),s=document.getElementById(`tools-${e}`),o=this.filteredTools.filter(t=>t.category===e).sort((e,t)=>e.name.localeCompare(t.name));s&&(s.innerHTML="");let n=!1;n=(this.searchTerm||"ALL"===this.currentFilter||this.currentFilter===e)&&o.length>0,t&&(t.style.display=n?"block":"none"),n&&s&&o.forEach(t=>{const o=this.createToolCard(t,e);s.appendChild(o)})})}createToolCard(e,t){const s=document.createElement("div");s.className=`tool-card tool-${t.toLowerCase()}`,s.draggable=!this.isMobile(),s.dataset.name=e.name;const o=[...e.tags||this.CATEGORY_TAGS[e.category]||[]].sort((e,t)=>e.localeCompare(t)),n=o.slice(0,3),i=o.length>3;return s.innerHTML=`\n            <div class="tool-card-content">\n                <div class="tool-header">\n                    <div class="tool-info">\n                        <div class="tool-name">\n                            ${e.name}\n                            ${e.videoUrl?'<span class="video-indicator">🎥</span>':""}\n                        </div>\n                        <div class="tool-type">${"CASH"===e.category?"Cash Tools":"LITE"===e.category?"TMS-Lite":e.category}</div>\n                    </div>\n                    <div class="tool-meta">\n                        ${e.logoUrl?`<img loading="lazy" class="tool-logo" src="${e.logoUrl}" alt="${e.name} logo">`:""}\n                        <div class="tool-icon">${{TRMS:"🏢",CASH:"💰",LITE:"⚡"}[e.category]}</div>\n                    </div>\n                </div>\n                <div class="tool-description">${e.desc}</div>\n            </div>\n            <div class="tool-card-actions">\n                <div class="tool-tags">\n                    ${n.map(e=>`<span class="tool-tag">${e}</span>`).join("")}\n                    ${i?`<button class="show-more-tags-btn" data-tool-name="${e.name}">... more</button>`:""}\n                </div>\n            </div>\n        `,s.addEventListener("click",t=>{t.target.closest(".show-more-tags-btn")||t.target.closest(".show-less-tags-btn")||this.showToolModal(e)}),this.isMobile()||(s.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.name),this.openShortlistMenu("dragstart")}),s.addEventListener("touchstart",()=>{this.touchDragTool=e,this.openShortlistMenu()}),s.addEventListener("touchmove",e=>{const t=document.getElementById("shortlistContainer");if(!t)return;const s=e.touches[0],o=document.elementFromPoint(s.clientX,s.clientY);o&&t.contains(o)?t.classList.add("drag-over"):t.classList.remove("drag-over"),e.preventDefault()},{passive:!1}),s.addEventListener("touchend",e=>{const t=document.getElementById("shortlistContainer");if(t&&t.classList.remove("drag-over"),this.touchDragTool&&t){const s=e.changedTouches[0],o=document.elementFromPoint(s.clientX,s.clientY);o&&t.contains(o)&&!this.shortlist.some(e=>e.tool.name===this.touchDragTool.name)&&(this.shortlist.push({tool:this.touchDragTool,notes:""}),this.renderShortlist())}this.touchDragTool=null})),s}populateCategoryTags(){["CASH","LITE","TRMS"].forEach(e=>{const t=document.getElementById(`category-tags-${e}`);if(t){const s=[...this.CATEGORY_TAGS[e]||[]].sort((e,t)=>e.localeCompare(t)),o=s.slice(0,3),n=s.length>3;t.innerHTML=o.map(e=>`<span class="category-tag">${e}</span>`).join(""),n&&(t.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${e}">... more</button>`)}})}populateTagFilters(){const e=document.getElementById("tagFilters");if(!e)return;const t=[...new Set(Object.values(this.CATEGORY_TAGS).flat())].sort((e,t)=>e.localeCompare(t));this.allTags=t;const s=t.slice(0,4),o=t.slice(4),n=e=>{const t=`tag-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`};e.innerHTML=s.map(n).join(""),o.length&&(e.innerHTML+=`<div id="extraTagFilters" style="display:none;">${o.map(n).join("")}</div>`,e.innerHTML+='<button class="show-more-filter-tags-btn" id="showMoreTagFilters">Show more</button>',e.innerHTML+='<button class="show-less-filter-tags-btn" id="showLessTagFilters" style="display:none;">Show less</button>')}updateVisibleCounts(){let e=0;["CASH","LITE","TRMS"].forEach(t=>{const s=this.filteredTools.filter(e=>e.category===t).length,o=document.getElementById(`count-${t}`);o&&(o.textContent=s),e+=s});const t=document.getElementById("totalTools");t&&(t.textContent=this.searchTerm?e:this.TREASURY_TOOLS.length)}updateCounts(){["CASH","LITE","TRMS"].forEach(e=>{const t=this.TREASURY_TOOLS.filter(t=>t.category===e).length,s=document.getElementById(`count-${e}`);s&&(s.textContent=t)});const e=document.getElementById("totalTools");e&&(e.textContent=this.TREASURY_TOOLS.length)}setupSideMenu(){const e=document.getElementById("sideMenuToggle"),t=document.getElementById("externalMenuToggle"),s=document.getElementById("sideMenu"),o=document.getElementById("sideMenuOverlay");e&&e.addEventListener("click",()=>this.toggleSideMenu()),t&&t.addEventListener("click",()=>this.toggleSideMenu()),o&&o.addEventListener("click",()=>this.closeSideMenu()),s&&s.addEventListener("click",e=>{this.isMobile()||this.sideMenuOpen||e.target!==s||(e.stopPropagation(),this.openSideMenu())}),this.setupAdvancedFilters(),this.setupViewOptions(),this.setupQuickActions(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.sideMenuOpen&&this.closeSideMenu()})}setupAdvancedFilters(){this.populateTagFilters(),this.setupTagSearch();const e=document.getElementById("showMoreTagFilters"),t=document.getElementById("showLessTagFilters"),s=document.getElementById("extraTagFilters");e&&t&&s&&(e.addEventListener("click",()=>{s.style.display="block",e.style.display="none",t.style.display="inline-block"}),t.addEventListener("click",()=>{s.style.display="none",t.style.display="none",e.style.display="inline-block"}));document.querySelectorAll('#tagFilters input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{this.updateFeatureFilters(),this.filterAndDisplayTools(),this.updateFilterCount()})});const o=document.getElementById("hasVideoFilter");o&&o.addEventListener("change",e=>{this.advancedFilters.hasVideo=e.target.checked,this.filterAndDisplayTools(),this.updateFilterCount()});const n=document.getElementById("sortFilter");n&&n.addEventListener("change",e=>{this.currentSort=e.target.value,this.filterAndDisplayTools()})}setupViewOptions(){const e=document.querySelectorAll(".view-option");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),this.currentView=t.dataset.view,this.applyViewStyles()})});const t=document.getElementById("groupByFilter");t&&t.addEventListener("change",e=>{this.groupByCategory="category"===e.target.value,this.filterAndDisplayTools()})}setupQuickActions(){const e=document.getElementById("clearAllFilters");e&&e.addEventListener("click",()=>this.clearAllFilters());const t=document.getElementById("resetToDefaults");t&&t.addEventListener("click",()=>this.resetToDefaults());const s=document.getElementById("applyFilters");s&&s.addEventListener("click",()=>{this.filterAndDisplayTools(),this.closeSideMenu()})}toggleSideMenu(){this.sideMenuOpen?this.closeSideMenu():this.openSideMenu()}openSideMenu(){this.closeShortlistMenu();const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");e?.classList.add("open"),document.body.classList.add("side-menu-open"),t?.classList.add("show"),s?.classList.add("active"),o?.classList.add("active"),document.body.style.overflow="hidden",document.addEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!0}closeSideMenu(){const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");e?.classList.remove("open"),t?.classList.remove("show"),s?.classList.remove("active"),o?.classList.remove("active"),document.body.classList.remove("side-menu-open"),document.body.style.overflow="",document.removeEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!1}setupShortlistMenu(){const e=document.getElementById("shortlistMenuToggle"),t=document.getElementById("shortlistMenuOverlay"),s=document.getElementById("externalShortlistToggle"),o=document.getElementById("shortlistContainer"),n=document.getElementById("clearShortlist"),i=document.getElementById("exportShortlistBtn");e&&e.addEventListener("click",()=>this.toggleShortlistMenu()),s&&s.addEventListener("click",()=>this.toggleShortlistMenu()),t&&(t.addEventListener("dragover",e=>e.preventDefault()),t.addEventListener("drop",e=>e.preventDefault()));const a=document.getElementById("shortlistMenu");if(a&&a.addEventListener("click",e=>{this.isMobile()||this.shortlistMenuOpen||e.target!==a||(e.stopPropagation(),this.openShortlistMenu())}),n&&n.addEventListener("click",()=>this.clearShortlist()),i&&i.addEventListener("click",()=>this.exportShortlist()),o){let e=null,t=null;const s=()=>o.classList.add("drag-over"),n=()=>o.classList.remove("drag-over");o.addEventListener("dragstart",t=>{t.target.classList.contains("shortlist-card")?(e=t.target,t.dataTransfer.setData("text/plain",t.target.dataset.name),t.dataTransfer.effectAllowed="move"):e=null}),o.addEventListener("dragenter",s),o.addEventListener("dragleave",e=>{e.target===o&&n()}),o.addEventListener("dragover",t=>{if(t.preventDefault(),e){const s=t.target.closest(".shortlist-card");if(s&&s!==e){const n=s.getBoundingClientRect(),i=t.clientY-n.top>n.height/2;o.insertBefore(e,i?s.nextSibling:s)}}}),o.addEventListener("drop",t=>{if(t.preventDefault(),n(),e)this.shortlist=Array.from(o.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),e=null,this.renderShortlist();else{const e=t.dataTransfer.getData("text/plain"),s=this.TREASURY_TOOLS.find(t=>t.name===e);s&&!this.shortlist.some(t=>t.tool.name===e)&&(this.shortlist.push({tool:s,notes:""}),this.renderShortlist())}}),o.addEventListener("touchstart",e=>{const o=e.target.closest(".shortlist-card");o&&(t=o,s())}),o.addEventListener("touchmove",e=>{if(!t)return;const s=e.touches[0],n=document.elementFromPoint(s.clientX,s.clientY)?.closest(".shortlist-card");if(n&&n!==t){const e=n.getBoundingClientRect(),i=s.clientY-e.top>e.height/2;o.insertBefore(t,i?n.nextSibling:n)}e.preventDefault()},{passive:!1}),o.addEventListener("touchend",()=>{t&&(n(),this.shortlist=Array.from(o.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),t=null,this.renderShortlist())}),o.addEventListener("click",e=>{e.target!==o||o.querySelector("#toolPicker")||this.openToolPicker()})}document.addEventListener("keydown",e=>{"Escape"===e.key&&this.shortlistMenuOpen&&this.closeShortlistMenu()}),this.renderShortlist()}toggleShortlistMenu(){this.shortlistMenuOpen?this.closeShortlistMenu():this.openShortlistMenu()}openShortlistMenu(e){this.closeSideMenu();const t=document.getElementById("shortlistMenu"),s=document.getElementById("shortlistMenuOverlay"),o=document.getElementById("shortlistMenuToggle"),n=document.getElementById("externalShortlistToggle");t?.classList.add("open"),document.body.classList.add("shortlist-menu-open"),s?.classList.add("show"),document.addEventListener("click",this.handleOutsideShortlistMenuClick),o?.classList.add("active"),n?.classList.add("active"),document.body.style.overflow="hidden",this.shortlistMenuOpen=!0}closeShortlistMenu(){const e=document.getElementById("shortlistMenu"),t=document.getElementById("shortlistMenuOverlay"),s=document.getElementById("shortlistMenuToggle"),o=document.getElementById("externalShortlistToggle");e?.classList.remove("open"),document.body.classList.remove("shortlist-menu-open"),t?.classList.remove("show"),document.removeEventListener("click",this.handleOutsideShortlistMenuClick),s?.classList.remove("active"),o?.classList.remove("active"),document.body.style.overflow="",this.shortlistMenuOpen=!1}renderShortlist(){const e=document.getElementById("shortlistContainer"),t=document.getElementById("shortlistEmptyMessage");if(!e)return;e.innerHTML="",t&&e.appendChild(t),0===this.shortlist.length?(e.classList.add("empty"),t&&t.classList.remove("visually-hidden")):(e.classList.remove("empty"),t&&t.classList.add("visually-hidden"),this.shortlist.forEach(t=>{const s=document.createElement("div");s.className="shortlist-card",s.draggable=!0,s.dataset.name=t.tool.name,s.innerHTML=`\n                    <div class="shortlist-card-header">\n                        <div class="shortlist-card-title-wrapper">\n                            <span class="shortlist-card-title">${t.tool.name}</span>\n                            ${t.tool.websiteUrl?`<a class="shortlist-card-link" href="${t.tool.websiteUrl}" target="_blank" rel="noopener noreferrer" title="Visit website">↗</a>`:""}\n                        </div>\n                        <div class="shortlist-card-buttons">\n                            <button class="move-up" data-name="${t.tool.name}" aria-label="Move up">▲</button>\n                            <button class="move-down" data-name="${t.tool.name}" aria-label="Move down">▼</button>\n                            <button class="remove-shortlist" data-name="${t.tool.name}" aria-label="Remove">×</button>\n                        </div>\n                    </div>\n                    <textarea class="shortlist-note" data-name="${t.tool.name}" placeholder="Notes...">${t.notes||""}</textarea>`,e.appendChild(s)})),e.querySelectorAll(".remove-shortlist").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name;this.shortlist=this.shortlist.filter(e=>e.tool.name!==t),this.renderShortlist()})}),e.querySelectorAll(".move-up").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,s=this.shortlist.findIndex(e=>e.tool.name===t);if(s>0){const[e]=this.shortlist.splice(s,1);this.shortlist.splice(s-1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".move-down").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,s=this.shortlist.findIndex(e=>e.tool.name===t);if(s<this.shortlist.length-1&&-1!==s){const[e]=this.shortlist.splice(s,1);this.shortlist.splice(s+1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".shortlist-note").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.dataset.name,s=this.shortlist.find(e=>e.tool.name===t);s&&(s.notes=e.target.value)})});const s=document.getElementById("exportShortlistBtn");s&&(s.disabled=0===this.shortlist.length)}clearShortlist(){this.shortlist=[],this.renderShortlist()}openToolPicker(){const e=document.getElementById("shortlistContainer");if(!e)return;const t=document.getElementById("toolPicker");t&&t.remove();const s=document.createElement("select");s.id="toolPicker",s.innerHTML='<option value="" disabled selected>Select a tool</option>'+this.TREASURY_TOOLS.filter(e=>!this.shortlist.some(t=>t.tool.name===e.name)).map(e=>`<option value="${e.name}">${e.name}</option>`).join(""),s.addEventListener("change",()=>{const e=s.value,t=this.TREASURY_TOOLS.find(t=>t.name===e);t&&!this.shortlist.some(t=>t.tool.name===e)&&(this.shortlist.push({tool:t,notes:""}),this.renderShortlist()),s.remove()}),e.appendChild(s),s.focus()}setupBottomNav(){const e=document.getElementById("bottomSearch"),t=document.getElementById("bottomShortlist");if(e&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.sideMenuOpen?this.closeSideMenu():(this.openSideMenu(),setTimeout(()=>{const e=document.getElementById("searchInput");e&&(e.focus(),/iPad|iPhone|iPod/.test(navigator.userAgent)&&e.click())},350))}),t){let e,s;t.addEventListener("touchstart",t=>{e=t.touches[0].clientX,s=t.touches[0].clientY}),t.addEventListener("touchend",t=>{const o=Math.abs(t.changedTouches[0].clientX-e),n=Math.abs(t.changedTouches[0].clientY-s);o<10&&n<10&&(t.preventDefault(),this.toggleShortlistMenu())}),t.addEventListener("click",()=>this.toggleShortlistMenu())}}updateFeatureFilters(){const e=document.querySelectorAll('#tagFilters input[type="checkbox"]');this.advancedFilters.features=Array.from(e).filter(e=>e.checked).map(e=>e.value)}applyViewStyles(){document.querySelectorAll(".tools-grid").forEach(e=>{e.classList.remove("list-view"),"list"===this.currentView?(e.classList.add("list-view"),e.style.gridTemplateColumns="1fr"):e.style.gridTemplateColumns="repeat(auto-fill, minmax(320px, 1fr))"})}exportShortlist(){const e=this.shortlist.map(e=>({name:e.tool.name,category:e.tool.category,website:e.tool.websiteUrl?e.tool.websiteUrl.split("?")[0]:"",notes:e.notes||""})),t=this.convertToCSV(e);this.downloadCSV(t,"shortlist.csv")}convertToCSV(e){if(!e.length)return"";const t=Object.keys(e[0]);return[t.join(","),...e.map(e=>t.map(t=>`"${String(e[t]).replace(/"/g,'""')}"`).join(","))].join("\n")}downloadCSV(e,t){const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");if(void 0!==o.download){const e=URL.createObjectURL(s);o.setAttribute("href",e),o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),o.click(),URL.revokeObjectURL(e),document.body.removeChild(o)}}clearAllFilters(){const e=document.getElementById("searchInput");e&&(e.value="",this.searchTerm="");const t=document.getElementById("tagSearchInput");t&&(t.value="");const s=document.getElementById("tagSearchClear");s&&(s.style.display="none"),this.filterTagCheckboxes(""),document.querySelector(".filter-tab.active")?.classList.remove("active"),document.querySelector('.filter-tab[data-category="ALL"]')?.classList.add("active"),this.currentFilter="ALL",this.advancedFilters={features:[],hasVideo:!1};document.querySelectorAll('#tagFilters input[type="checkbox"],#hasVideoFilter').forEach(e=>e.checked=!1),this.filterAndDisplayTools(),this.updateFilterCount()}resetToDefaults(){this.clearAllFilters();const e=document.getElementById("sortFilter");e&&(e.value="name"),this.currentSort="name",document.querySelectorAll(".view-option").forEach(e=>e.classList.remove("active")),document.querySelector('.view-option[data-view="grid"]')?.classList.add("active"),this.currentView="grid";const t=document.getElementById("groupByFilter");t&&(t.value="category"),this.groupByCategory=!0,this.applyViewStyles(),this.filterAndDisplayTools()}updateFilterCount(){const{features:e,hasVideo:t}=this.advancedFilters;let s=0;s+=e.length,t&&s++;const o=document.getElementById("filterCount");o&&(o.textContent=s>0?`(${s})`:"")}}let lastTouchEnd=0;document.addEventListener("touchend",function(e){const t=Date.now();t-lastTouchEnd<=300&&e.preventDefault(),lastTouchEnd=t},{passive:!1});
